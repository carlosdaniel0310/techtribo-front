<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Apresentação Dinâmica</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg" style="background-color: #001846;">
        <div class="container">

            <a class="navbar-brand text-white fw-semibold" href="index.html">
                TechTribo - Tecnologia
            </a>

            <button class="navbar-toggler text-white" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="menu">

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link text-white" href="index.html">Início</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="apresentacao.html">Apresentação</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="favoritos.html">Favoritos ⭐</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="cadastro_desenvolvedores.html">Cadastrar
                            Desenvolvedor</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="informacoes.html">Sobre o Site</a></li>
                </ul>

            </div>

        </div>
    </nav>



    <section class="py-5">
        <div class="container text-center">

            <h2 class="fw-bold mb-4 text-primary">Distribuição de Desenvolvedores por Empresa</h2>

            <div class="d-flex justify-content-center">
                <div style="width: 100%; max-width: 700px;">
                    <canvas id="graficoDevEmpresas"></canvas>
                </div>
            </div>




            <p id="status" class="text-muted mt-3"></p>

        </div>
    </section>

    <section id="detalhes" class="py-5 bg-white">
        <div class="container">
            <h3 class="fw-semibold mb-3 text-primary">Detalhes da análise</h3>

            <div id="analiseTexto">
                <!-- O texto será criado automaticamente via JavaScript -->
                <p class="text-muted">Carregando análise...</p>
            </div>
        </div>
    </section>


    <footer class="py-4 mt-4 bg-white border-top">
        <div class="container text-center small text-muted">
            © <span id="anoCorrente"></span> TechTribo • Projeto acadêmico desenvolvido por Carlos Daniel Tempo Dutra
        </div>
    </footer>

    <script src="assets/scripts/app.js"></script>
    <script>
        const API_URL = "http://localhost:3000/desenvolvedores";

        let chart;

        async function carregarDados() {
            try {
                document.getElementById('status').textContent = "Carregando dados...";

                const resposta = await fetch(API_URL);
                const dados = await resposta.json();

                document.getElementById('status').textContent = `Carregado: ${dados.length} desenvolvedores`;

                // contar quantos devs existem por empresa
                const empresasMap = {};

                dados.forEach(dev => {
                    empresasMap[dev.empresa] = (empresasMap[dev.empresa] || 0) + 1;
                });

                const labels = Object.keys(empresasMap);
                const values = Object.values(empresasMap);

                return { labels, values };

            } catch (erro) {
                document.getElementById('status').textContent = "Erro ao carregar dados.";
                console.error(erro);
                return { labels: [], values: [] };
            }
        }

        async function desenharGrafico() {
            const { labels, values } = await carregarDados();

            const ctx = document.getElementById("graficoDevEmpresas");

            if (chart) {

                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.update();
                return;
            }

            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels,
                    datasets: [{
                        label: "Quantidade de Desenvolvedores",
                        data: values,
                        backgroundColor: "rgba(54, 162, 235, 0.5)",
                        borderColor: "rgba(54, 162, 235, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        desenharGrafico();

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const user = JSON.parse(localStorage.getItem("usuarioLogado"));
            const itemCadastrarDev = document.querySelector('a[href="cadastro_desenvolvedores.html"]');

            if (!user) return;

            if (!user.admin) {
                if (itemCadastrarDev) itemCadastrarDev.style.display = "none";
            }
        });
    </script>

    <script>
        async function atualizarAnalise() {
            const resposta = await fetch("http://localhost:3000/desenvolvedores");
            const dados = await resposta.json();

            // Contagem por empresa
            const empresasMap = {};
            dados.forEach(dev => {
                empresasMap[dev.empresa] = (empresasMap[dev.empresa] || 0) + 1;
            });

            const analiseDiv = document.getElementById("analiseTexto");

            let lista = "";
            for (const empresa in empresasMap) {
                lista += `<li>${empresa}: ${empresasMap[empresa]} desenvolvedor(es)</li>`;
            }

            analiseDiv.innerHTML = `
        <p>Atualmente, o sistema possui os seguintes desenvolvedores cadastrados por empresa:</p>

        <ul>${lista}</ul>

        <p>Com mais registros, o sistema poderá identificar:</p>

        <ul>
            <li>Empresas com maior número de desenvolvedores</li>
            <li>Distribuição dos talentos no mercado</li>
            <li>Padrões e oportunidades de contratação</li>
        </ul>

        <p>Essas informações serão atualizadas automaticamente conforme novos cadastros forem feitos.</p>
        <p>Essa análise serve como base para evolução do sistema de métricas no futuro.</p>
    `;
        }

        async function atualizarTudo() {
            await desenharGrafico();
            await atualizarAnalise();
        }

        atualizarTudo();
    </script>


</body>

</html>